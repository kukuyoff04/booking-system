<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .main-container { max-width: 800px; margin: auto; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .nav-pills .nav-link { border-radius: 50px; padding: 10px 20px; font-weight: 600; margin: 0 5px; color: #6c757d; }
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3); }
        .status-Booked { color: #0d6efd; background: #e7f1ff; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; }
        .status-Used { color: #198754; background: #d1e7dd; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; }
        .status-Cancelled { color: #dc3545; background: #f8d7da; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; }
        .btn-action { width: 32px; height: 32px; padding: 0; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; }
    </style>
</head>
<body>

<div class="container py-4 main-container">
    <h3 class="text-center mb-4 fw-bold text-primary"><i class="bi bi-shop-window"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h3>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded-pill shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-booking">üìù ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-admin">üîí Admin</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="pills-booking">
            <div class="card p-4">
                <form id="bookingForm">
                    <div class="mb-3"><label class="text-muted small">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" class="form-control" id="name" required></div>
                    <div class="mb-3"><label class="text-muted small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" class="form-control" id="phone" required></div>
                    <div class="mb-3"><label class="text-muted small">‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ / ‡πÇ‡∏ã‡∏ô</label><input type="text" class="form-control" id="tableNo" required></div>
                    <button type="submit" class="btn btn-primary w-100 py-2 rounded-pill shadow-sm" id="btnSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                </form>
            </div>
            <div id="ticketResult" class="card p-4 text-center d-none mt-3">
                <div class="mb-3"><i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i></div>
                <h5>‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h5>
                <p class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≠‡∏á: <span id="bookingId" class="fw-bold text-dark"></span></p>
                <img id="qrImage" src="" class="img-fluid border p-2 rounded mb-3" width="200">
                <button class="btn btn-outline-secondary w-100 rounded-pill" onclick="location.reload()">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-scan">
            <div class="card p-3">
                <div id="reader" class="bg-dark rounded overflow-hidden"></div>
                <div id="scanResult" class="mt-3 text-center">
                    <p class="text-muted small">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR Code</p>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-admin">
            <div class="card p-4">
                
                <div id="loginSection">
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-lock text-warning" style="font-size: 3rem;"></i>
                        <h5 class="mt-2">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h5>
                    </div>
                    <input type="password" id="adminPass" class="form-control text-center mb-3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    <button class="btn btn-dark w-100 rounded-pill" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

                <div id="adminData" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0 fw-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                        <button class="btn btn-sm btn-light text-primary rounded-pill px-3" onclick="loadAdminData()"><i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead class="table-light small text-muted">
                                <tr>
                                    <th>‡πÇ‡∏ï‡πä‡∏∞</th>
                                    <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                    <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="text-end">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="small"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-outline-danger btn-sm w-100 mt-3 rounded-pill" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤ Deploy ‡∏ó‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzNq-0Fp9ky-jhxlL6ETOokEtLEDZeBsaSB7FrjLIL3C0gKCtqS_wiMk__2M_nn8KCsTg/exec"; // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà

    let currentPass = ""; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

    // --- 1. Booking ---
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        const txt = btn.innerText;
        btn.disabled = true; btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        const fd = new FormData();
        fd.append('action', 'add');
        fd.append('Name', document.getElementById('name').value);
        fd.append('Phone', document.getElementById('phone').value);
        fd.append('Table', document.getElementById('tableNo').value);

        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') {
                document.getElementById('bookingForm').parentElement.classList.add('d-none');
                document.getElementById('ticketResult').classList.remove('d-none');
                document.getElementById('bookingId').innerText = res.id;
                document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${res.id}`;
            } else alert('Error: ' + JSON.stringify(res));
            btn.disabled = false; btn.innerText = txt;
        }).catch(err => { alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); btn.disabled = false; btn.innerText = txt; });
    });

    // --- 2. Scanner ---
    let scanner = null;
    document.querySelector('[data-bs-target="#pills-scan"]').addEventListener('shown.bs.tab', () => {
        if(!scanner) {
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render((txt) => { scanner.clear(); checkIn(txt); });
        }
    });

    function checkIn(id) {
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = '<div class="spinner-border text-primary"></div> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
        const fd = new FormData(); fd.append('action', 'checkin'); fd.append('id', id);
        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') resDiv.innerHTML = `<div class="alert alert-success">‚úÖ <b>${res.name}</b><br>‡πÇ‡∏ï‡πä‡∏∞: ${res.table}<br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div><button class="btn btn-primary w-100 rounded-pill" onclick="location.reload()">‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠</button>`;
            else resDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${res.message}</div><button class="btn btn-secondary w-100 rounded-pill" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>`;
        });
    }

    // --- 3. Admin (Secure) ---
    function doLogin() {
        const pass = document.getElementById('adminPass').value;
        const btn = document.querySelector('#loginSection button');
        btn.disabled = true; btn.innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

        // ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà Server (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô JS)
        const fd = new FormData(); 
        fd.append('action', 'login'); 
        fd.append('password', pass);

        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') {
                currentPass = pass; // ‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                document.getElementById('loginSection').classList.add('d-none');
                document.getElementById('adminData').classList.remove('d-none');
                loadAdminData();
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö!');
            }
            btn.disabled = false; btn.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        }).catch(err => { alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); btn.disabled = false; });
    }

    function loadAdminData() {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
        
        const fd = new FormData(); 
        fd.append('action', 'get_data');
        fd.append('password', currentPass); // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(rows => {
            let html = '';
            if(rows.length === 0) html = '<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>';
            
            rows.forEach(r => {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô)
                let cancelBtn = (r.status == 'Booked') ? 
                    `<button class="btn btn-action btn-outline-warning" onclick="updateStatus('${r.id}', 'cancel')" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"><i class="bi bi-x-lg"></i></button>` : '';
                
                // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞ - ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£)
                let deleteBtn = `<button class="btn btn-action btn-outline-danger" onclick="updateStatus('${r.id}', 'delete')" title="‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏≤‡∏ß‡∏£"><i class="bi bi-trash"></i></button>`;

                html += `<tr>
                    <td class="fw-bold text-primary">${r.table}</td>
                    <td>
                        <div class="fw-bold">${r.name}</div>
                        <div class="text-muted" style="font-size:0.8em">${r.phone}</div>
                    </td>
                    <td class="text-center"><span class="status-${r.status}">${r.status}</span></td>
                    <td class="text-end">
                        ${cancelBtn}
                        ${deleteBtn}
                    </td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = html;
        });
    }

    function updateStatus(id, actionType) {
        let confirmMsg = actionType == 'delete' ? '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡∏≤‡∏ß‡∏£?\n(‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?';
        if(!confirm(confirmMsg)) return;

        const fd = new FormData(); 
        fd.append('action', actionType); 
        fd.append('id', id);
        fd.append('password', currentPass); // ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') loadAdminData();
            else alert('‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        });
    }

    function logout() {
        currentPass = "";
        document.getElementById('adminPass').value = "";
        document.getElementById('loginSection').classList.remove('d-none');
        document.getElementById('adminData').classList.add('d-none');
    }
</script>

</body>
</html>
