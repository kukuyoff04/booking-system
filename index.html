<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞ & Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        .main-container { max-width: 800px; margin: auto; }
        .card { border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: none; }
        .nav-pills .nav-link { border-radius: 50px; padding: 8px 20px; font-weight: bold; margin: 0 5px; }
        .nav-pills .nav-link.active { background-color: #0d6efd; }
        .status-Booked { color: #0d6efd; font-weight: bold; }
        .status-Used { color: #198754; font-weight: bold; }
        .status-Cancelled { color: #dc3545; text-decoration: line-through; color: gray; }
    </style>
</head>
<body>

<div class="container py-3 main-container">
    <h3 class="text-center mb-3 fw-bold text-primary"><i class="bi bi-shop"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h3>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded-pill shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-booking">üìù ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-admin">üîí Admin</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-booking">
            <div class="card p-4">
                <form id="bookingForm">
                    <div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" class="form-control" id="name" required></div>
                    <div class="mb-3"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" class="form-control" id="phone" required></div>
                    <div class="mb-3"><label>‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞</label><input type="text" class="form-control" id="tableNo" required></div>
                    <button type="submit" class="btn btn-primary w-100" id="btnSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>
            <div id="ticketResult" class="card p-4 text-center d-none mt-3">
                <h5 class="text-success">‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h5>
                <p>‡∏£‡∏´‡∏±‡∏™: <span id="bookingId" class="fw-bold"></span></p>
                <img id="qrImage" src="" class="img-fluid border p-1" width="200">
                <button class="btn btn-secondary w-100 mt-2" onclick="location.reload()">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-scan">
            <div class="card p-3">
                <div id="reader"></div>
                <div id="scanResult" class="mt-3 text-center"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-admin">
            <div class="card p-4">
                <div id="loginSection">
                    <h5 class="text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô</h5>
                    <input type="password" id="adminPass" class="form-control mb-2 text-center" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)">
                    <button class="btn btn-dark w-100" onclick="checkLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

                <div id="adminData" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAdminData()"><i class="bi bi-arrow-clockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover text-center" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th>‡πÇ‡∏ï‡πä‡∏∞</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ---------------------------------------------------
    // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚ö†Ô∏è
    // ---------------------------------------------------
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzhIRxlPhsCKG_NO0uDLY4UqOMrPPwreBu_bR9QiQ4t7UgsRp8ozorfUJXNHGH01U-xKA/exec";

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≠‡∏á ---
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true; btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        
        const fd = new FormData();
        fd.append('action', 'add');
        fd.append('Name', document.getElementById('name').value);
        fd.append('Phone', document.getElementById('phone').value);
        fd.append('Table', document.getElementById('tableNo').value);

        fetch(WEB_APP_URL, { method: 'POST', body: fd })
            .then(r => r.json()).then(res => {
                if(res.result == 'success') {
                    document.getElementById('bookingForm').parentElement.classList.add('d-none');
                    document.getElementById('ticketResult').classList.remove('d-none');
                    document.getElementById('bookingId').innerText = res.id;
                    document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${res.id}`;
                } else { alert('Error: ' + JSON.stringify(res)); }
                btn.disabled = false; btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            });
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô ---
    let scanner = null;
    document.querySelector('[data-bs-target="#pills-scan"]').addEventListener('shown.bs.tab', () => {
        if(!scanner) {
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render((txt) => {
                scanner.clear();
                checkIn(txt);
            });
        }
    });

    function checkIn(id) {
        const resDiv = document.getElementById('scanResult');
        resDiv.innerHTML = 'Checking...';
        const fd = new FormData(); fd.append('action', 'checkin'); fd.append('id', id);
        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') resDiv.innerHTML = `<div class="alert alert-success">‚úÖ <b>${res.name}</b><br>‡πÇ‡∏ï‡πä‡∏∞: ${res.table}<br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div><button class="btn btn-primary mt-2" onclick="location.reload()">‡∏ï‡πà‡∏≠</button>`;
            else resDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${res.message}</div><button class="btn btn-secondary mt-2" onclick="location.reload()">‡πÉ‡∏´‡∏°‡πà</button>`;
        });
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô Admin ---
    function checkLogin() {
        if(document.getElementById('adminPass').value === '1234') { // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('adminData').classList.remove('d-none');
            loadAdminData();
        } else { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î!'); }
    }

    function loadAdminData() {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        const fd = new FormData(); fd.append('action', 'get_data');
        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(rows => {
            let html = '';
            rows.forEach(r => {
                let btnHtml = '';
                if(r.status == 'Booked') {
                    btnHtml = `<button class="btn btn-sm btn-danger" onclick="cancelBooking('${r.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;
                }
                html += `<tr>
                    <td>${r.table}</td>
                    <td class="text-start"><small>${r.name}</small><br><small class="text-muted">${r.phone}</small></td>
                    <td><span class="status-${r.status}">${r.status}</span><br><small style="font-size:10px">${r.time}</small></td>
                    <td>${btnHtml}</td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = html;
        });
    }

    function cancelBooking(id) {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ?')) return;
        const fd = new FormData(); fd.append('action', 'cancel'); fd.append('id', id);
        fetch(WEB_APP_URL, { method: 'POST', body: fd }).then(r=>r.json()).then(res => {
            if(res.result == 'success') loadAdminData();
            else alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
        });
    }
</script>

</body>
</html>
